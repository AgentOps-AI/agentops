name: Add Notebook Examples to Docs

on:
  push:
    branches:
      - main
      # TODO: Remove this branch once the workflow is stable
      - fix/examples-cleanup
    paths:
      - 'examples/**'
      - 'docs/v2/examples/**'
      - '.github/workflows/add-notebook-examples-to-docs.yml'

  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  add-notebook-examples-to-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install jupyter nbconvert

      - name: Convert notebooks to markdown and add to docs
        run: |
          set -x  # Enable debug mode
          for file in docs/v2/examples/*.mdx; do
            echo "Processing file: $file"
            source_file=$(grep -oP '(?<=\{/\*  SOURCE_FILE: ).*(?=  \*/\})' "$file" || true)
            if [[ -z "$source_file" ]]; then
              continue
            fi
            echo "Source file: $source_file"
            if [[ -f "$source_file" ]]; then
              echo "Converting notebook to markdown"
              jupyter nbconvert --to markdown "$source_file" || { echo "Error: Failed to convert $source_file" >&2; continue; }
              markdown_file="${source_file%.ipynb}.md"
              
              # Extract pip install commands from converted markdown
              echo "Extracting pip install commands from markdown"
              pip_packages=$(sed -n 's/.*%pip install \(.*\)/\1/p' "$markdown_file" | head -1 || true)
              
              # Replace %pip install lines with installation section if packages found
              if [[ -n "$pip_packages" ]]; then
                echo "Found pip packages: $pip_packages"
                echo "Replacing %pip install line with installation section"
                # Create installation section using echo commands
                echo "## Installation" > /tmp/install_section
                echo "<CodeGroup>" >> /tmp/install_section
                echo "  \`\`\`bash pip" >> /tmp/install_section
                echo "  pip install $pip_packages" >> /tmp/install_section
                echo "  \`\`\`" >> /tmp/install_section
                echo "  \`\`\`bash poetry" >> /tmp/install_section
                echo "  poetry add $pip_packages" >> /tmp/install_section
                echo "  \`\`\`" >> /tmp/install_section
                echo "  \`\`\`bash uv" >> /tmp/install_section
                echo "  uv add $pip_packages" >> /tmp/install_section
                echo "  \`\`\`" >> /tmp/install_section
                echo "</CodeGroup>" >> /tmp/install_section
                # Replace the %pip install line with the installation section
                sed "/.*%pip install.*/r /tmp/install_section" "$markdown_file" | sed "/.*%pip install.*/d" > /tmp/temp_md
                mv /tmp/temp_md "$markdown_file"
              fi
              
              echo "Removing existing content after {/* SOURCE_FILE: ... */}"
              sed -i '\#{/\*  SOURCE_FILE:#,$d' "$file"
              echo "Appending markdown to $file"
              echo -e "{/*  SOURCE_FILE: $source_file  */}\n" >> "$file"
              echo "_View Notebook on <a href={'https://github.com/AgentOps-AI/agentops/blob/main/$source_file'} target={'_blank'}>Github</a>_" >> "$file"
              echo "" >> "$file"
              
              cat "$markdown_file" >> "$file" || { echo "Error: Failed to append markdown to $file" >&2; continue; }
              rm "$markdown_file" || { echo "Error: Failed to remove $markdown_file" >&2; continue; }
            else
              echo "Error: Source file not found: $source_file" >&2
            fi
          done

      - name: Disable git hooks for automated commits
        run: |
          # Disable pre-commit hooks for this automated workflow
          git config core.hooksPath /dev/null

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          committer: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          commit-message: GitHub Action - Update examples in docs from notebooks
          title: GitHub Action - Update examples in docs from notebooks
          body: Changes detected in examples/** or docs/v2/examples/** triggered an update of the docs/v2/examples/**.mdx files to incorporate markdown from the corresponding notebook in examples/**.
          branch: update-examples-in-docs-from-notebooks
          delete-branch: true
          # TODO: Uncomment for production use
          # assignees: the-praxs,bboynton97,areibman
          # reviewers: the-praxs,bboynton97,areibman
          # TODO: Remove this once the workflow is stable
          assignees: the-praxs
          reviewers: the-praxs
